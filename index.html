<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Focus Tracker HUD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* -------------------------
   GLOBAL STYLE + HUD COLORS
   ------------------------- */
body {
    font-family: 'Orbitron', sans-serif;
    background: radial-gradient(circle at center, #04121f, #000000);
    color: #d6f3ff;
    margin: 0;
    overflow: hidden;
}

h1, h2 {
    font-family: 'Orbitron', sans-serif;
    letter-spacing: 2px;
}

a, button, input {
    font-family: inherit;
}

/* HUD glow */
.hud-glow {
    text-shadow: 0 0 10px #39eaff, 0 0 20px #39eaff;
}

/* -------------------------
   STARTUP OVERLAY ANIMATION
   ------------------------- */
#startup-screen {
    position: fixed;
    inset: 0;
    background: black;
    color: #39eaff;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 24px;
    z-index: 9999;
    animation: fadeOut 1.8s ease 2.6s forwards;
}

@keyframes fadeOut {
    to { opacity: 0; pointer-events: none; }
}

#boot-text {
    border-right: 3px solid #39eaff;
    white-space: nowrap;
    overflow: hidden;
    width: 0;
    animation: typing 2.6s steps(40) forwards;
}

@keyframes typing {
    from { width: 0; }
    to { width: 440px; }
}

/* -------------------------
   MAIN HUD LAYOUT
   ------------------------- */
#hud-wrapper {
    display: flex;
    padding: 20px;
    gap: 20px;
}

#left-panel, #right-panel {
    background: rgba(0, 37, 58, 0.35);
    padding: 20px;
    border: 2px solid #1ab6ff;
    border-radius: 10px;
    box-shadow: 0 0 10px #1ab6ff55;
    backdrop-filter: blur(4px);
}

/* camera HUD box */
#camera-box {
    border: 2px solid #00ffb3;
    box-shadow: 0 0 10px #00ffb388;
    padding: 10px;
    text-align: center;
}

/* prediction HUD */
#label-container div {
    margin-top: 6px;
    padding: 3px 8px;
    background: rgba(0,0,0,0.3);
    border-left: 3px solid #39eaff;
    font-size: 14px;
    border-radius: 4px;
}

/* sliders */
input[type="range"] {
    width: 100%;
}

/* Pomodoro Timer */
#timer-display {
    font-size: 32px;
    margin: 10px 0;
    color: #00ffb3;
    text-shadow: 0 0 10px #00ffb3;
}

/* distraction log */
#log-box {
    max-height: 150px;
    overflow-y: auto;
    background: rgba(0,0,0,0.2);
    padding: 10px;
    border: 1px solid #39eaff55;
    border-radius: 5px;
}

/* buttons */
button {
    background: #1ab6ff;
    border: none;
    color: black;
    padding: 10px 15px;
    font-weight: bold;
    cursor: pointer;
    border-radius: 6px;
    margin-top: 6px;
    transition: 0.2s;
}

button:hover {
    background: #39eaff;
}
</style>
</head>
<body>

<!-- -------------------------
     STARTUP BOOT SEQUENCE
     ------------------------- -->
<div id="startup-screen">
    <div id="boot-text">
        INITIALIZING FOCUS TRACKER SYSTEM... <br>
        LOADING POSE MODEL... <br>
        SYNCING HUD MODULES... <br>
        SYSTEM ONLINE.
    </div>
</div>

<!-- -------------------------
     MAIN CONTENT + TITLE
     ------------------------- -->
<h1 class="hud-glow" style="text-align:center; margin-top:20px;">Focus Tracker HUD</h1>
<p style="text-align:center; max-width:700px; margin:auto;">
A gaming-HUD–themed posture & attention monitor that detects **Focus**, **Distraction**,  
and **Break Mode** using Google’s Teachable Machine Pose Model.
</p>

<!-- -------------------------
     HUD LAYOUT (horizontal)
     ------------------------- -->
<div id="hud-wrapper">

    <!-- LEFT PANEL – CAMERA, MODEL, CONTROLS -->
    <div id="left-panel" style="flex: 1;">
        <h2 class="hud-glow">Live Tracker</h2>

        <button onclick="init()">Start Camera</button>

        <div id="camera-box">
            <canvas id="canvas"></canvas>
        </div>

        <h3>Sensitivity</h3>
        <input type="range" id="sensitivity-slider" min="0.1" max="0.9" value="0.5" step="0.05">
        <p>Current: <span id="sensitivity-read">0.5</span></p>

        <h3>Status</h3>
        <div id="label-container"></div>
    </div>

    <!-- RIGHT PANEL – TIMER, LOG, MODE INFO  -->
    <div id="right-panel" style="flex: 1;">
        <h2 class="hud-glow">Productivity Suite</h2>

        <!-- ------------------ TIMER ------------------ -->
        <h3>Pomodoro Timer</h3>
        <div id="timer-display">25:00</div>
        <button onclick="startTimer()">Start</button>
        <button onclick="resetTimer()">Reset</button>

        <!-- ------------------ LOG ------------------ -->
        <h3>Distraction Log</h3>
        <div id="log-box"></div>
        <button onclick="downloadLog()">Download CSV</button>
    </div>
</div>

<!-- -------------------------
     AUDIO ALERT
     ------------------------- -->
<audio id="alert-sound">
    <source src="data:audio/wav;base64,UklGRoABAABXQVZFZm10IBAAAAABAAEARKwAABCxAgAEABAAZGF0YUABAAAAAACAgICAgICAgICAgICAf4CAf4KAgICAgICAgH+Af4CAgICAgICAgICAgICAgICAgICAgICAgICAgICAg" type="audio/wav">
</audio>

<!-- -------------------------
     TEACHABLE MACHINE + JS
     ------------------------- -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js"></script>

<script>
// ---------------------------------------------------------------
// MODEL SETUP (unchanged except for hooks)
// ---------------------------------------------------------------
const URL = "./my_model/";
let model, webcam, ctx, labelContainer, maxPredictions;

let currentClass = "Focused";
let sensitivity = 0.5;
let distractionLog = [];

// arcade beep-boop sound
const alertSound = document.getElementById("alert-sound");

// sensitivity slider
document.getElementById("sensitivity-slider").oninput = function() {
    sensitivity = parseFloat(this.value);
    document.getElementById("sensitivity-read").innerText = sensitivity.toFixed(2);
};

// ---------------------------------------------------------------
// TIMER
// ---------------------------------------------------------------
let timeLeft = 25 * 60;
let timerInterval = null;

function updateTimerDisplay() {
    const m = Math.floor(timeLeft / 60);
    const s = timeLeft % 60;
    document.getElementById("timer-display").innerText =
        `${m}:${s.toString().padStart(2, "0")}`;
}

function startTimer() {
    if (timerInterval) return;
    timerInterval = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();
        if (timeLeft <= 0) resetTimer();
    }, 1000);
}

function resetTimer() {
    clearInterval(timerInterval);
    timerInterval = null;
    timeLeft = 25 * 60;
    updateTimerDisplay();
}

// ---------------------------------------------------------------
// DISTRACTION LOG
// ---------------------------------------------------------------
function logDistraction() {
    const ts = new Date().toLocaleString();
    distractionLog.push(ts);
    const box = document.getElementById("log-box");
    box.innerHTML += `<div>Distraction @ ${ts}</div>`;
}

function downloadLog() {
    const csv = "timestamp\n" + distractionLog.join("\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "distractions.csv";
    a.click();
}

// ---------------------------------------------------------------
// TEACHABLE MACHINE LOGIC
// ---------------------------------------------------------------
async function init() {
    const modelURL = URL + "model.json";
    const metadataURL = URL + "metadata.json";

    model = await tmPose.load(modelURL, metadataURL);
    maxPredictions = model.getTotalClasses();

    const size = 200;
    webcam = new tmPose.Webcam(size, size, true);
    await webcam.setup();
    await webcam.play();
    window.requestAnimationFrame(loop);

    const canvas = document.getElementById("canvas");
    canvas.width = size;
    canvas.height = size;
    ctx = canvas.getContext("2d");

    labelContainer = document.getElementById("label-container");
    for (let i = 0; i < maxPredictions; i++) {
        labelContainer.appendChild(document.createElement("div"));
    }
}

async function loop() {
    webcam.update();
    await predict();
    window.requestAnimationFrame(loop);
}

async function predict() {
    const { pose, posenetOutput } = await model.estimatePose(webcam.canvas);
    const prediction = await model.predict(posenetOutput);

    let highest = { name: "", prob: 0 };

    for (let i = 0; i < maxPredictions; i++) {
        const p = prediction[i];
        labelContainer.childNodes[i].innerHTML = `${p.className}: ${p.probability.toFixed(2)}`;

        if (p.probability > highest.prob) highest = { name: p.className, prob: p.probability };
    }

    // threshold filtering
    if (highest.prob > sensitivity && highest.name !== currentClass) {
        currentClass = highest.name;

        if (currentClass === "Distracted") {
            alertSound.play();
            logDistraction();
        }
    }

    drawPose(pose);
}

function drawPose(pose) {
    if (webcam.canvas) {
        ctx.drawImage(webcam.canvas, 0, 0);
        if (pose) {
            tmPose.drawKeypoints(pose.keypoints, 0.5, ctx);
            tmPose.drawSkeleton(pose.keypoints, 0.5, ctx);
        }
    }
}
</script>
</body>
</html>
