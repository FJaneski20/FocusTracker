<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Focus Tracker HUD</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    font-family: 'Orbitron', sans-serif;
    background: radial-gradient(circle at center, #04121f, #000000);
    color: #d6f3ff;
    margin: 0;
    overflow-x: hidden;
}

h1, h2 {
    font-family: 'Orbitron', sans-serif;
    letter-spacing: 2px;
}

.hud-glow {
    text-shadow: 0 0 10px #39eaff, 0 0 20px #39eaff;
}

/* STARTUP ANIMATION */
#startup-screen {
    position: fixed;
    inset: 0;
    background: black;
    color: #39eaff;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 24px;
    z-index: 9999;
    animation: fadeOut 1.8s ease 2.6s forwards;
}
@keyframes fadeOut { to { opacity: 0; pointer-events: none; } }
#boot-text {
    border-right: 3px solid #39eaff;
    white-space: nowrap;
    overflow: hidden;
    width: 0;
    animation: typing 2.6s steps(40) forwards;
}
@keyframes typing { from { width: 0; } to { width: 440px; } }

/* HORIZONTAL HUD LAYOUT */
#hud-wrapper {
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    padding: 15px;
    gap: 20px;
}

/* LEFT PANEL = CAMERA + STATUS */
#left-panel {
    width: 60%;
    background: rgba(0, 37, 58, 0.35);
    border: 2px solid #1ab6ff;
    border-radius: 10px;
    padding: 15px;
    backdrop-filter: blur(4px);
}

/* RIGHT PANEL = TIMER + LOG */
#right-panel {
    width: 38%;
    background: rgba(0, 37, 58, 0.35);
    border: 2px solid #1ab6ff;
    border-radius: 10px;
    padding: 15px;
    backdrop-filter: blur(4px);
}

/* CAMERA BOX — NOW WIDE */
#camera-box {
    border: 2px solid #00ffb3;
    box-shadow: 0 0 10px #00ffb388;
    padding: 10px;
    width: 100%;
    display: flex;
    justify-content: center;
}
#canvas {
    width: 100% !important;
    height: auto !important;
}

/* HORIZONTAL CONTROL BAR */
#top-controls {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
}

input[type="range"] {
    width: 200px;
}

/* BUTTONS */
button {
    background: #1ab6ff;
    border: none;
    color: black;
    padding: 10px 15px;
    font-weight: bold;
    cursor: pointer;
    border-radius: 6px;
}
button:hover { background: #39eaff; }

/* PREDICTION LABELS */
#label-container div {
    padding: 4px 10px;
    margin: 4px 0;
    background: rgba(0,0,0,0.4);
    border-left: 3px solid #39eaff;
}

/* TIMER */
#timer-display {
    font-size: 38px;
    color: #00ffb3;
    text-shadow: 0 0 10px #00ffb3;
}

/* LOG */
#log-box {
    height: 180px;
    overflow-y: auto;
    background: rgba(0,0,0,0.3);
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #39eaff55;
}
</style>
</head>
<body>

<!-- STARTUP BOOT SEQUENCE -->
<div id="startup-screen">
    <div id="boot-text">
        INITIALIZING FOCUS TRACKER SYSTEM... <br>
        LOADING POSE MODEL... <br>
        SYNCING HUD MODULES... <br>
        SYSTEM ONLINE.
    </div>
</div>

<h1 class="hud-glow" style="text-align:center; margin-top:20px;">Focus Tracker HUD</h1>
<p style="text-align:center; max-width:700px; margin:auto;">
A gaming-HUD–styled posture and focus tracker using Google’s Teachable Machine Pose Model.
</p>

<!-- MAIN HORIZONTAL HUD -->
<div id="hud-wrapper">

    <!-- LEFT: CAMERA + STATUS -->
    <div id="left-panel">
        <h2 class="hud-glow">Live Focus Tracking</h2>

        <div id="top-controls">
            <button onclick="init()">Start Camera</button>
            <span>Sensitivity:</span>
            <input type="range" id="sensitivity-slider" min="0.1" max="0.9" value="0.5" step="0.05">
            <span id="sensitivity-read">0.5</span>
        </div>

        <div id="camera-box">
            <canvas id="canvas"></canvas>
        </div>

        <h3>Status Classification</h3>
        <div id="label-container"></div>
    </div>

    <!-- RIGHT: TIMER + LOG -->
    <div id="right-panel">
        <h2 class="hud-glow">Productivity Panel</h2>

        <h3>Pomodoro Timer</h3>
        <div id="timer-display">25:00</div>
        <button onclick="startTimer()">Start</button>
        <button onclick="resetTimer()">Reset</button>

        <h3>Distraction Log</h3>
        <div id="log-box"></div>
        <button onclick="downloadLog()">Download CSV</button>
    </div>
</div>

<!-- ARCADE BEEP-BOOP SOUND -->
<audio id="alert-sound">
    <source src="data:audio/wav;base64,UklGRoABAABXQVZFZm10IBAAAAABAAEARKwAABCxAgAEABAAZGF0YUABAAAAAACAgICAgICAgICAgICAf4CAf4KAgICAgICAgH+Af4CAgICAgICAgICAgICAgICAgICAgICAgICAgICAg" type="audio/wav">
</audio>

<!-- TEACHABLE MACHINE SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js"></script>

<script>
// ---------------------------------------------------------------
// MODEL SETUP
// ---------------------------------------------------------------
const URL = "./my_model/";
let model, webcam, ctx, labelContainer, maxPredictions;

let currentClass = "Focused";
let sensitivity = 0.5;
let distractionLog = [];

// arcade beep-boop sound
const alertSound = document.getElementById("alert-sound");

// update slider readout
document.getElementById("sensitivity-slider").oninput = function() {
    sensitivity = parseFloat(this.value);
    document.getElementById("sensitivity-read").innerText = sensitivity.toFixed(2);
};

// ---------------------------------------------------------------
// TIMER (Pomodoro)
// ---------------------------------------------------------------
let timeLeft = 25 * 60;
let timerInterval = null;

function updateTimerDisplay() {
    const m = Math.floor(timeLeft / 60);
    const s = timeLeft % 60;
    document.getElementById("timer-display").innerText =
        `${m}:${s.toString().padStart(2, "0")}`;
}

function startTimer() {
    if (timerInterval) return;
    timerInterval = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();
        if (timeLeft <= 0) resetTimer();
    }, 1000);
}

function resetTimer() {
    clearInterval(timerInterval);
    timerInterval = null;
    timeLeft = 25 * 60;
    updateTimerDisplay();
}

// ---------------------------------------------------------------
// LOGGING DISTRACTIONS
// ---------------------------------------------------------------
function logDistraction() {
    const ts = new Date().toLocaleString();
    distractionLog.push(ts);
    const box = document.getElementById("log-box");
    box.innerHTML += `<div>Distraction @ ${ts}</div>`;
}

function downloadLog() {
    const csv = "timestamp\n" + distractionLog.join("\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "distractions.csv";
    a.click();
}

// ---------------------------------------------------------------
// TEACHABLE MACHINE MAIN LOGIC
// ---------------------------------------------------------------
async function init() {
    const modelURL = URL + "model.json";
    const metadataURL = URL + "metadata.json";

    model = await tmPose.load(modelURL, metadataURL);
    maxPredictions = model.getTotalClasses();

    const size = 200;
    webcam = new tmPose.Webcam(size, size, true);
    await webcam.setup();
    await webcam.play();
    window.requestAnimationFrame(loop);

    const canvas = document.getElementById("canvas");
    canvas.width = size;
    canvas.height = size;
    ctx = canvas.getContext("2d");

    labelContainer = document.getElementById("label-container");
    for (let i = 0; i < maxPredictions; i++) {
        labelContainer.appendChild(document.createElement("div"));
    }
}

async function loop() {
    webcam.update();
    await predict();
    window.requestAnimationFrame(loop);
}

async function predict() {
    const { pose, posenetOutput } = await model.estimatePose(webcam.canvas);
    const prediction = await model.predict(posenetOutput);

    let highest = { name: "", prob: 0 };

    for (let i = 0; i < maxPredictions; i++) {
        const p = prediction[i];
        labelContainer.childNodes[i].innerHTML =
            `${p.className}: ${p.probability.toFixed(2)}`;

        if (p.probability > highest.prob)
            highest = { name: p.className, prob: p.probability };
    }

    if (highest.prob > sensitivity && highest.name !== currentClass) {
        currentClass = highest.name;

        // play sound + log
        if (currentClass === "Distracted") {
            alertSound.play();
            logDistraction();
        }
    }

    drawPose(pose);
}

function drawPose(pose) {
    if (webcam.canvas) {
        ctx.drawImage(webcam.canvas, 0, 0);
        if (pose) {
            tmPose.drawKeypoints(pose.keypoints, 0.5, ctx);
            tmPose.drawSkeleton(pose.keypoints, 0.5, ctx);
        }
    }
}
</script>

</body>
</html>
